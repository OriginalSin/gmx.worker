{"version":3,"file":"index.js","sources":["src/worker/Requests.js","src/worker/TilesLoader.js","src/worker/DataSourceVersion.js","src/worker/index.js"],"sourcesContent":["\r\nconst\t_self = self || window;\r\n\t\t// serverBase = _self.serverBase || 'maps.kosmosnimki.ru/',\r\n\t\t// serverProxy = serverBase + 'Plugins/ForestReport/proxy',\r\n\t\t// gmxProxy = '//maps.kosmosnimki.ru/ApiSave.ashx';\r\n\r\n// let _app = {},\r\n\t// loaderStatus = {},\r\n\t// _sessionKeys = {},\r\nlet str = _self.location.origin || '',\r\n\t_protocol = str.substring(0, str.indexOf('/')),\r\n\tsyncParams = {},\r\n\tfetchOptions = {\r\n\t\t// method: 'post',\r\n\t\t// headers: {'Content-type': 'application/x-www-form-urlencoded'},\r\n\t\tmode: 'cors',\r\n\t\t// redirect: 'follow',\r\n\t\tcredentials: 'include'\r\n\t};\r\n\r\nconst COMPARS = {WrapStyle: 'None', ftc: 'osm', srs: 3857};\r\n\r\nconst setSyncParams = (hash) => {\t// установка дополнительных параметров для серверных запросов\r\n\tsyncParams = hash;\r\n};\r\nconst getSyncParams = (stringFlag) => {\r\n\tvar res = syncParams;\r\n\tif (stringFlag) {\r\n\t\tvar arr = [];\r\n\t\tfor (var key in res) {\r\n\t\t\tarr.push(key + '=' + res[key]);\r\n\t\t}\r\n\t\tres = arr.join('&');\r\n\t}\r\n\treturn res;\r\n};\r\n\r\nconst parseURLParams = (str) => {\r\n\tlet sp = new URLSearchParams(str || location.search),\r\n\t\tout = {},\r\n\t\tarr = [];\r\n\tfor (let p of sp) {\r\n\t\tlet k = p[0], z = p[1];\r\n\t\tif (z) {\r\n\t\t\tif (!out[k]) {out[k] = [];}\r\n\t\t\tout[k].push(z);\r\n\t\t} else {\r\n\t\t\tarr.push(k);\r\n\t\t}\r\n\t}\r\n\treturn {main: arr, keys: out};\r\n};\r\nlet utils = {\r\n\textend: function (dest) {\r\n\t\tvar i, j, len, src;\r\n\r\n\t\tfor (j = 1, len = arguments.length; j < len; j++) {\r\n\t\t\tsrc = arguments[j];\r\n\t\t\tfor (i in src) {\r\n\t\t\t\tdest[i] = src[i];\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn dest;\r\n\t},\r\n\r\n\tmakeTileKeys: function(it, ptiles) {\r\n\t\tvar tklen = it.tilesOrder.length,\r\n\t\t\tarr = it.tiles,\r\n\t\t\ttiles = {},\r\n\t\t\tnewTiles = {};\r\n\r\n\t\twhile (arr.length) {\r\n\t\t\tvar t = arr.splice(0, tklen),\r\n\t\t\t\ttk = t.join('_'),\r\n\t\t\t\ttile = ptiles[tk];\r\n\t\t\tif (!tile || !tile.data) {\r\n\t\t\t\tif (!tile) {\r\n\t\t\t\t\ttiles[tk] = {\r\n\t\t\t\t\t\ttp: {z: t[0], x: t[1], y: t[2], v: t[3], s: t[4], d: t[5]}\r\n\t\t\t\t\t};\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttiles[tk] = tile;\r\n\t\t\t\t}\r\n\t\t\t\tnewTiles[tk] = true;\r\n\t\t\t} else {\r\n\t\t\t\ttiles[tk] = tile;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn {tiles: tiles, newTiles: newTiles};\r\n\t},\r\n\r\n\tgetZoomRange: function(info) {\r\n\t\tvar arr = info.properties.styles,\r\n\t\t\tout = [40, 0];\r\n\t\tfor (var i = 0, len = arr.length; i < len; i++) {\r\n\t\t\tvar st = arr[i];\r\n\t\t\tout[0] = Math.min(out[0], st.MinZoom);\r\n\t\t\tout[1] = Math.max(out[1], st.MaxZoom);\r\n\t\t}\r\n\t\tout[0] = out[0] === 40 ? 1 : out[0];\r\n\t\tout[1] = out[1] === 0 ? 22 : out[1];\r\n\t\treturn out;\r\n\t},\r\n\r\n\tchkProtocol: function(url) {\r\n\t\treturn url.substr(0, _protocol.length) === _protocol ? url : _protocol + url;\r\n\t},\r\n\tgetFormBody: function(par) {\r\n\t\treturn Object.keys(par).map(function(key) { return encodeURIComponent(key) + '=' + encodeURIComponent(par[key]); }).join('&');\r\n\t},\r\n\tchkResponse: function(resp, type) {\r\n\t\tif (resp.status < 200 || resp.status >= 300) {\t\t\t\t\t\t// error\r\n\t\t\treturn Promise.reject(resp);\r\n\t\t} else {\r\n\t\t\tvar contentType = resp.headers.get('Content-Type');\r\n\t\t\tif (type === 'bitmap') {\t\t\t\t\t\t\t\t\t\t\t\t// get blob\r\n\t\t\t\treturn resp.blob();\r\n\t\t\t} else if (contentType.indexOf('application/json') > -1) {\t\t\t\t// application/json; charset=utf-8\r\n\t\t\t\treturn resp.json();\r\n\t\t\t} else if (contentType.indexOf('text/javascript') > -1) {\t \t\t\t// text/javascript; charset=utf-8\r\n\t\t\t\treturn resp.text();\r\n\t\t\t// } else if (contentType.indexOf('application/json') > -1) {\t \t\t// application/json; charset=utf-8\r\n\t\t\t\t// ret = resp.text();\r\n\t\t\t// } else if (contentType.indexOf('application/json') > -1) {\t \t\t// application/json; charset=utf-8\r\n\t\t\t\t// ret = resp.formData();\r\n\t\t\t// } else if (contentType.indexOf('application/json') > -1) {\t \t\t// application/json; charset=utf-8\r\n\t\t\t\t// ret = resp.arrayBuffer();\r\n\t\t\t// } else {\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn resp.text();\r\n\t},\r\n\tgetBitMap: function(url) {\r\n\t\tlet options = {type: 'bitmap'};\r\n\t\treturn fetch(url, options)\r\n\t\t.then(function(res) {\r\n\t\t\treturn utils.chkResponse(res, options.type);\r\n\t\t// })\r\n\t\t// .then(function(blob) {\r\n\t\t\t// return createImageBitmap(blob, {\r\n\t\t\t\t// premultiplyAlpha: 'none',\r\n\t\t\t\t// colorSpaceConversion: 'none'\r\n\t\t\t// });\r\n\t\t});\r\n\t},\r\n\tgetTileJson: function(queue) {\r\n\t\tlet params = queue.params || {};\r\n\t\tif (queue.paramsArr) {\r\n\t\t\tqueue.paramsArr.forEach((it) => {\r\n\t\t\t\tparams = utils.extend(params, it);\r\n\t\t\t});\r\n\t\t}\r\n\t\tlet par = utils.extend({}, fetchOptions, COMPARS, params, syncParams),\r\n\t\t\toptions = queue.options || {};\r\n\t\treturn fetch(queue.url + '?' + utils.getFormBody(par))\r\n\t\t.then(function(res) {\r\n\t\t\treturn utils.chkResponse(res, options.type);\r\n\t\t});\r\n\t},\r\n\tgetJson: function(queue) {\r\n\t\tlet params = queue.params || {};\r\n\t\tif (queue.paramsArr) {\r\n\t\t\tqueue.paramsArr.forEach((it) => {\r\n\t\t\t\tparams = utils.extend(params, it);\r\n\t\t\t});\r\n\t\t}\r\n\t\tlet par = utils.extend({}, params, syncParams),\r\n\t\t\toptions = queue.options || {},\r\n\t\t\topt = utils.extend({\r\n\t\t\t\tmethod: 'post',\r\n\t\t\t\theaders: {'Content-type': 'application/x-www-form-urlencoded'}\r\n\t\t\t}, fetchOptions, options, {\r\n\t\t\t\tbody: utils.getFormBody(par)\r\n\t\t\t});\r\n\t\treturn fetch(utils.chkProtocol(queue.url), opt)\r\n\t\t.then(function(res) {\r\n\t\t\treturn utils.chkResponse(res, options.type);\r\n\t\t})\r\n\t\t.then(function(res) {\r\n\t\t\treturn {url: queue.url, queue: queue, load: true, res: res};\r\n\t\t})\r\n\t\t.catch(function(err) {\r\n\t\t\treturn {url: queue.url, queue: queue, load: false, error: err.toString()};\r\n\t\t\t// handler.workerContext.postMessage(out);\r\n\t\t});\r\n    },\r\n};\r\n/*\r\nconst requestSessionKey = (serverHost, apiKey) => {\r\n\tlet keys = _sessionKeys;\r\n\tif (!(serverHost in keys)) {\r\n\t\tkeys[serverHost] = new Promise(function(resolve, reject) {\r\n\t\t\tif (apiKey) {\r\n\t\t\t\tutils.getJson({\r\n\t\t\t\t\turl: '//' + serverHost + '/ApiKey.ashx',\r\n\t\t\t\t\tparams: {WrapStyle: 'None', Key: apiKey}\r\n\t\t\t\t})\r\n\t\t\t\t\t.then(function(json) {\r\n\t\t\t\t\t\tlet res = json.res;\r\n\t\t\t\t\t\tif (res.Status === 'ok' && res.Result) {\r\n\t\t\t\t\t\t\tresolve(res.Result.Key !== 'null' ? '' : res.Result.Key);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\treject(json);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.catch(function() {\r\n\t\t\t\t\t\tresolve('');\r\n\t\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tresolve('');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\treturn keys[serverHost];\r\n};\r\nlet _maps = {};\r\nconst getMapTree = (pars) => {\r\n\tpars = pars || {};\r\n\tlet hostName = pars.hostName || serverBase,\r\n\t\tid = pars.mapId;\r\n\treturn utils.getJson({\r\n\t\turl: '//' + hostName + '/Map/GetMapFolder',\r\n\t\t// options: {},\r\n\t\tparams: {\r\n\t\t\tsrs: 3857, \r\n\t\t\tskipTiles: 'All',\r\n\r\n\t\t\tmapId: id,\r\n\t\t\tfolderId: 'root',\r\n\t\t\tvisibleItemOnly: false\r\n\t\t}\r\n\t})\r\n\t\t.then(function(json) {\r\n\t\t\tlet out = parseTree(json.res);\r\n\t\t\t_maps[hostName] = _maps[hostName] || {};\r\n\t\t\t_maps[hostName][id] = out;\r\n\t\t\treturn parseTree(out);\r\n\t\t});\r\n};\r\nconst getReq = url => {\r\n\treturn fetch(url, {\r\n\t\t\tmethod: 'get',\r\n\t\t\tmode: 'cors',\r\n\t\t\tcredentials: 'include'\r\n\t\t// headers: {'Accept': 'application/json'},\r\n\t\t// body: JSON.stringify(params)\t// TODO: сервер почему то не хочет работать так https://googlechrome.github.io/samples/fetch-api/fetch-post.html\r\n\t\t})\r\n\t\t.then(res => res.json())\r\n\t\t.catch(err => console.warn(err));\r\n};\r\n\r\n// const getLayerItems = (params) => {\r\n\t// params = params || {};\r\n\r\n\t// let url = `${serverBase}VectorLayer/Search.ashx`;\r\n\t// url += '?layer=' + params.layerID;\r\n\t// if (params.id) { '&query=gmx_id=' + params.id; }\r\n\r\n\t// url += '&out_cs=EPSG:4326';\r\n\t// url += '&geometry=true';\r\n\t// return getReq(url);\r\n// };\r\n// const getReportsCount = () => {\r\n\t// return getReq(serverProxy + '?path=/rest/v1/get-current-user-info');\r\n// };\r\n\r\nlet dataSources = {},\r\n\tloaderStatus1 = {};\r\n\r\nconst addDataSource = (pars) => {\r\n\tpars = pars || {};\r\n\r\n\tlet id = pars.id;\r\n\tif (id) {\r\n\t\tlet hostName = pars.hostName;\r\n\t\t\r\n\t} else {\r\n\t\tconsole.warn('Warning: Specify layer \\'id\\' and \\'hostName\\`', pars);\r\n\t}\r\nconsole.log('addDataSource:', pars);\r\n\treturn;\r\n};\r\n\r\nconst removeDataSource = (pars) => {\r\n\tpars = pars || {};\r\n\r\n\tlet id = pars.id;\r\n\tif (id) {\r\n\t\tlet hostName = pars.hostName;\r\n\t\t\r\n\t} else {\r\n\t\tconsole.warn('Warning: Specify layer \\'id\\' and \\'hostName\\`', pars);\r\n\t}\r\nconsole.log('removeDataSource:', pars);\r\n\t//Requests.removeDataSource({id: message.layerID, hostName: message.hostName}).then((json) => {\r\n\treturn;\r\n};\r\nlet _maps = {};\r\nconst getMapTree = (pars) => {\r\n\tpars = pars || {};\r\n\tlet hostName = pars.hostName || 'maps.kosmosnimki.ru',\r\n\t\tid = pars.mapID;\r\n\treturn utils.getJson({\r\n\t\turl: '//' + hostName + '/Map/GetMapFolder',\r\n\t\t// options: {},\r\n\t\tparams: {\r\n\t\t\tsrs: 3857, \r\n\t\t\tskipTiles: 'All',\r\n\r\n\t\t\tmapId: id,\r\n\t\t\tfolderId: 'root',\r\n\t\t\tvisibleItemOnly: false\r\n\t\t}\r\n\t})\r\n\t\t// .then(function(json) {\r\n\t\t\t// let out = parseTree(json.res);\r\n\t\t\t// _maps[hostName] = _maps[hostName] || {};\r\n\t\t\t// _maps[hostName][id] = out;\r\n\t\t\t// return parseTree(out);\r\n\t\t// });\r\n};\r\n\r\nconst _iterateNodeChilds = (node, level, out) => {\r\n\tlevel = level || 0;\r\n\tout = out || {\r\n\t\tlayers: []\r\n\t};\r\n\t\r\n\tif (node) {\r\n\t\tlet type = node.type,\r\n\t\t\tcontent = node.content,\r\n\t\t\tprops = content.properties;\r\n\t\tif (type === 'layer') {\r\n\t\t\tlet ph = utils.parseLayerProps(props);\r\n\t\t\tph.level = level;\r\n\t\t\tif (content.geometry) { ph.geometry = content.geometry; }\r\n\t\t\tout.layers.push(ph);\r\n\t\t} else if (type === 'group') {\r\n\t\t\tlet childs = content.children || [];\r\n\t\t\tout.layers.push({ level: level, group: true, childsLen: childs.length, properties: props });\r\n\t\t\tchilds.map((it) => {\r\n\t\t\t\t_iterateNodeChilds(it, level + 1, out);\r\n\t\t\t});\r\n\t\t}\r\n\t\t\r\n\t} else {\r\n\t\treturn out;\r\n\t}\r\n\treturn out;\r\n};\r\n\r\nconst parseTree = (json) => {\r\n\tlet out = {};\r\n\tif (json.Status === 'error') {\r\n\t\tout = json;\r\n\t} else if (json.Result && json.Result.content) {\r\n\t\tout = _iterateNodeChilds(json.Result);\r\n\t\tout.mapAttr = out.layers.shift();\r\n\t}\r\n// console.log('______json_out_______', out, json)\r\n\treturn out;\r\n};\r\n*/\r\n\r\nconst chkSignal = (signalName, signals, opt) => {\r\n\topt = opt || {};\r\n\tlet sObj = signals[signalName];\r\n// console.log('sssssss', sObj, signalName)\r\n\tif (sObj) { sObj.abort(); }\r\n\tsObj = signals[signalName] = new AbortController();\r\n\tsObj.signal.addEventListener('abort', (ev) => console.log('Отмена fetch:', ev));\r\n\topt.signal = sObj.signal;\r\n\tsignals[signalName] = sObj;\r\n\treturn opt;\r\n};\r\n\r\nexport default {\r\n\tchkSignal,\r\n\tCOMPARS,\r\n\tsetSyncParams,\r\n\tgetSyncParams,\r\n\tparseURLParams,\r\n\t// getMapTree,\r\n\textend: utils.extend,\r\n\tgetBitMap: utils.getBitMap,\r\n\tgetFormBody: utils.getFormBody,\r\n\tgetTileJson: utils.getTileJson,\r\n\tgetJson: utils.getJson\r\n\t// addDataSource,\r\n\t// removeDataSource,\r\n\t// getReportsCount,\r\n\t// getLayerItems\r\n};","import Requests from './Requests';\r\n\r\nconst TILE_PREFIX = 'gmxAPI._vectorTileReceiver(';\r\n\r\nconst load = (pars) => {\r\n\tpars = pars || {};\r\n\tif (!pars.signals) { pars.signals = {}; }\r\n\tif (!pars.tilesPromise) { pars.tilesPromise = {}; }\r\n\t\r\n\t// return new Promise((resolve) => {\r\n\t\tlet tilesOrder = pars.tilesOrder,\r\n\t\t\tpb = pars.tiles,\r\n\t\t\ttilesPromise = {};\r\n\t\tfor (let i = 0, len = pb.length; i < len; i += tilesOrder.length) {\r\n\t\t\tlet arr = pb.slice(i, i + tilesOrder.length),\r\n\t\t\t\ttkey = arr.join('_'),\r\n\t\t\t\ttHash = tilesOrder.reduce((p, c, j) => { p[c] = arr[j]; return p; }, {});\r\n\r\n\t\t\tif (pars.tilesPromise[tkey]) {\r\n\t\t\t\ttilesPromise[tkey] = pars.tilesPromise[tkey];\r\n\t\t\t} else {\r\n\t\t\t\t// pars.tilesPromise[tkey] = Requests.getTileJson({\r\n\t\t\t\ttilesPromise[tkey] = Requests.getTileJson({\r\n\t\t\t\t\turl: '//' + pars.hostName + '/TileSender.ashx',\r\n\t\t\t\t\toptions: Requests.chkSignal(tkey, pars.signals),\r\n\t\t\t\t\tparamsArr: [tHash, {\r\n\t\t\t\t\t\tr: 'j',\r\n\t\t\t\t\t\tModeKey: 'tile',\r\n\t\t\t\t\t\tLayerName: pars.id,\r\n\t\t\t\t\t}]\r\n\t\t\t\t}).then(json => {\r\n\t\t\t\t\tdelete pars.signals[tkey];\r\n\t\t\t\t\tif (typeof(json) === 'string') {\r\n\t\t\t\t\t\tif (json.substr(0, TILE_PREFIX.length) === TILE_PREFIX) {\r\n\t\t\t\t\t\t\tjson = json.replace(TILE_PREFIX, '');\r\n\t\t\t\t\t\t\tjson = JSON.parse(json.substr(0, json.length -1));\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn json;\r\n\t\t\t\t})\r\n\t\t\t\t.catch(err => {\r\n\t\t\t\t\tconsole.error(err);\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t}\r\n\t\tObject.keys(pars.signals).forEach(k => {\r\n\t\t\tif (!tilesPromise[k]) {\r\n\t\t\t\tpars.signals[k].abort();\r\n\t\t\t\tdelete pars.signals[k];\r\n\t\t\t}\r\n\t\t});\r\n\t\tpars.tilesPromise = tilesPromise;\r\n\t\t// return out;\r\n\t\t// Promise.all(arr).then((out) => {\r\n\t\t\t// resolve(out);\r\n\t\t// });\r\n\t// });\r\n};\r\n\r\nexport default {\r\n\tload\r\n};","import Requests from './Requests';\r\nimport TilesLoader from './TilesLoader';\r\n\r\nconst HOST = 'maps.kosmosnimki.ru',\r\n    WORLDWIDTHFULL = 40075016.685578496,\r\n\tW = WORLDWIDTHFULL / 2,\r\n\tWORLDBBOX = [[-W, -W, W, W]],\r\n    SCRIPT = '/Layer/CheckVersion.ashx',\r\n\tGMXPROXY = '//maps.kosmosnimki.ru/ApiSave.ashx',\r\n\tMINZOOM = 1,\r\n\tMAXZOOM = 22,\r\n    STYLEKEYS = {\r\n        marker: {\r\n            server: ['image',   'angle',     'scale',     'minScale',     'maxScale',     'size',         'circle',     'center',     'color'],\r\n            client: ['iconUrl', 'iconAngle', 'iconScale', 'iconMinScale', 'iconMaxScale', 'iconSize', 'iconCircle', 'iconCenter', 'iconColor']\r\n        },\r\n        outline: {\r\n            server: ['color',  'opacity',   'thickness', 'dashes'],\r\n            client: ['color',  'opacity',   'weight',    'dashArray']\r\n        },\r\n        fill: {\r\n            server: ['color',     'opacity',   'image',       'pattern',     'radialGradient',     'linearGradient'],\r\n            client: ['fillColor', 'fillOpacity', 'fillIconUrl', 'fillPattern', 'fillRadialGradient', 'fillLinearGradient']\r\n        },\r\n        label: {\r\n            server: ['text',      'field',      'template',      'color',      'haloColor',      'size',          'spacing',      'align'],\r\n            client: ['labelText', 'labelField', 'labelTemplate', 'labelColor', 'labelHaloColor', 'labelFontSize', 'labelSpacing', 'labelAlign']\r\n        }\r\n    },\r\n    STYLEFUNCKEYS = {\r\n        // iconUrl: 'iconUrlFunction',\r\n        iconSize: 'iconSizeFunction',\r\n        iconAngle: 'rotateFunction',\r\n        iconScale: 'scaleFunction',\r\n        iconColor: 'iconColorFunction',\r\n        opacity: 'opacityFunction',\r\n        fillOpacity: 'fillOpacityFunction',\r\n        color: 'colorFunction',\r\n        fillColor: 'fillColorFunction'\r\n/*\r\n    },\r\n\r\n    STYLEFUNCERROR = {\r\n        // iconUrl: function() { return ''; },\r\n        iconSize: function() { return 8; },\r\n        iconAngle: function() { return 0; },\r\n        iconScale: function() { return 1; },\r\n        iconColor: function() { return 0xFF; },\r\n        opacity: function() { return 1; },\r\n        fillOpacity: function() { return 0.5; },\r\n        color: function() { return 0xFF; },\r\n        fillColor: function() { return 0xFF; }\r\n    },\r\n    DEFAULTSTYLES = {\r\n       MinZoom: 1,\r\n       MaxZoom: 21,\r\n       Filter: '',\r\n       Balloon: '',\r\n       DisableBalloonOnMouseMove: true,\r\n       DisableBalloonOnClick: false,\r\n       RenderStyle: {\r\n            point: {    // old = {outline: {color: 255, thickness: 1}, marker:{size: 8}},\r\n                color: 0xFF,\r\n                weight: 1,\r\n                iconSize: 8\r\n            },\r\n            linestring: {    // old = {outline: {color: 255, thickness: 1}},\r\n                color: 0xFF,\r\n                weight: 1\r\n            },\r\n            polygon: {    // old = {outline: {color: 255, thickness: 1}},\r\n                color: 0xFF,\r\n                weight: 1\r\n            }\r\n        }\r\n*/\r\n    };\r\n\r\nlet hosts = {},\r\n    zoom = 3,\r\n    bbox = null,\r\n\t// dataManagersLinks = {},\r\n    // hostBusy = {},\r\n    // needReq = {}\r\n    delay = 60000,\r\n\tintervalID = null,\r\n    timeoutID = null;\r\n\r\nconst utils = {\r\n    now: function() {\r\n\t\tif (timeoutID) { clearTimeout(timeoutID); }\r\n\t\ttimeoutID = setTimeout(chkVersion, 0);\r\n    },\r\n\r\n    stop: function() {\r\n\t\tconsole.log('stop:', intervalID, delay);\r\n        if (intervalID) { clearInterval(intervalID); }\r\n        intervalID = null;\r\n    },\r\n\r\n    start: function(msec) {\r\n\t\tconsole.log('start:', intervalID, msec);\r\n        if (msec) { delay = msec; }\r\n        utils.stop();\r\n        intervalID = setInterval(chkVersion, delay);\r\n    },\r\n/*\r\n    parseLayerProps: function(prop) {\r\n\t\t// let ph = utils.getTileAttributes(prop);\r\n\t\treturn Requests.extend(\r\n\t\t\t{\r\n\t\t\t\tproperties: prop\r\n\t\t\t},\r\n\t\t\tutils.getTileAttributes(prop),\r\n\t\t\tutils.parseStyles(prop),\r\n\t\t\tutils.parseMetaProps(prop)\r\n\t\t);\r\n    },\r\n*/\r\n    parseFilter: function(str) {\r\n\t\tlet regex1 = /\"(.+?)\" in \\((.+?)\\)/g,\r\n\t\t\tregex2 = /\"(.+?)\"/g,\r\n\t\t\tregexMath = /(floor\\()/g,\r\n\t\t\tbody = str ? str\r\n\t\t\t\t.replace(/[[\\]]/g, '\"')\r\n\t\t\t\t.replace(regex1, '[$2].includes(props[indexes[\\'$1\\']])')\r\n\t\t\t\t.replace(regex2, 'props[indexes[\\'$1\\']]')\r\n\t\t\t\t.replace(/=/g, '===')\r\n\t\t\t\t.replace(/\\bAND\\b/g, '&&')\r\n\t\t\t\t.replace(/\\bOR\\b/g, '||')\r\n\t\t\t\t.replace(regexMath, 'Math.$1')\r\n\t\t\t\t: true;\r\n\t\treturn {\r\n\t\t\tfilter: str,\r\n\t\t\tfilterParsed: body,\r\n\t\t\tfilterFun: new Function('props', 'indexes', 'return ' + body + ';')\r\n\t\t};\r\n    },\r\n\r\n// StyleManager.decodeOldStyles = function(props) {\r\n    // var styles = props.styles,\r\n\t\t// arr = styles || [{MinZoom: 1, MaxZoom: 21, RenderStyle: StyleManager.DEFAULT_STYLE}],\r\n\t\t// type = props.type.toLocaleLowerCase(),\r\n\t\t// gmxStyles = {\r\n\t\t\t// attrKeys: {},\r\n\t\t\t// iconsUrl: {}\r\n\t\t// };\r\n\t// gmxStyles.styles = arr.map(function(it) {\r\n        // var pt = {\r\n            // Name: it.Name || '',\r\n            // type: type || '',\r\n\t\t\tlegend: false,\r\n            // MinZoom: it.MinZoom || 0,\r\n            // MaxZoom: it.MaxZoom || 18\r\n        // };\r\n\t\t// pt.labelMinZoom = it.labelMinZoom || pt.MinZoom;\r\n\t\t// pt.labelMaxZoom = it.labelMaxZoom || pt.MaxZoom;\r\n\r\n        // if ('Balloon' in it) {\r\n            // pt.Balloon = it.Balloon;\r\n\t\t\t// var hash = StyleManager.getKeysHash(it.Balloon, 'Balloon');\r\n\t\t\t// if (Object.keys(hash).length) {\r\n\t\t\t\t// L.extend(gmxStyles.attrKeys, hash);\r\n\t\t\t// }\r\n        // }\r\n        // if (it.RenderStyle) {\r\n            // var rt = StyleManager.decodeOldStyle(it.RenderStyle);\r\n\t\t\t// L.extend(gmxStyles.attrKeys, rt.attrKeys);\r\n\t\t\t// if (rt.style.iconUrl) { gmxStyles.iconsUrl[rt.style.iconUrl] = true; }\r\n            // pt.RenderStyle = rt.style;\r\n\t\t\t// if (it.HoverStyle === undefined) {\r\n\t\t\t\t// var hoveredStyle = JSON.parse(JSON.stringify(pt.RenderStyle));\r\n\t\t\t\t// if (hoveredStyle.outline) { hoveredStyle.outline.thickness += 1; }\r\n\t\t\t\t// pt.HoverStyle = hoveredStyle;\r\n\t\t\t// } else if (it.HoverStyle === null) {\r\n\t\t\t\t// delete pt.HoverStyle;\r\n\t\t\t// } else {\r\n\t\t\t\t// var ht = StyleManager.decodeOldStyle(it.HoverStyle);\r\n\t\t\t\t// pt.HoverStyle = ht.style;\r\n\t\t\t// }\r\n        // } else if (type === 'vector ') {\r\n            // pt.RenderStyle = StyleManager.DEFAULT_STYLE;\r\n\t\t// }\r\n\r\n        // if ('DisableBalloonOnMouseMove' in it) {\r\n            // pt.DisableBalloonOnMouseMove = it.DisableBalloonOnMouseMove === false ? false : true;\r\n        // }\r\n        // if ('DisableBalloonOnClick' in it) {\r\n            // pt.DisableBalloonOnClick = it.DisableBalloonOnClick || false;\r\n        // }\r\n        // if ('Filter' in it) {\t// TODO: переделать на new Function = function(props, indexes, types)\r\n// /*eslint-disable no-useless-escape */\r\n            // pt.Filter = it.Filter;\r\n            // var ph = L.gmx.Parsers.parseSQL(it.Filter.replace(/[\\[\\]]/g, '\"'));\r\n// /*eslint-enable */\r\n\t\t\t// TODO: need body for function ƒ (props, indexes, types)\r\n            // if (ph) { pt.filterFunction = ph; }\r\n        // }\r\n\t\t// return pt;\r\n\t// });\r\n    // return gmxStyles;\r\n// };\r\n\r\n\tdecodeOldStyle: function(style) {   // Style Scanex->leaflet\r\n\t\tlet st, i, len, key, key1,\r\n\t\t\tstyleOut = {};\r\n\t\t\t// attrKeys = {},\r\n\t\t\t// type = '';\r\n\r\n\t\tfor (key in STYLEKEYS) {\r\n\t\t\tlet keys = STYLEKEYS[key];\r\n\t\t\tfor (i = 0, len = keys.client.length; i < len; i++) {\r\n\t\t\t\tkey1 = keys.client[i];\r\n\t\t\t\tif (key1 in style) {\r\n\t\t\t\t\tstyleOut[key1] = style[key1];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tst = style[key];\r\n\t\t\tif (st && typeof (st) === 'object') {\r\n\t\t\t\tfor (i = 0, len = keys.server.length; i < len; i++) {\r\n\t\t\t\t\tkey1 = keys.server[i];\r\n\t\t\t\t\tif (key1 in st) {\r\n\t\t\t\t\t\tvar newKey = keys.client[i],\r\n\t\t\t\t\t\t\tzn = st[key1];\r\n\t\t\t\t\t\tif (typeof (zn) === 'string') {\r\n\t\t\t\t\t\t\t// var hash = StyleManager.getKeysHash(zn, newKey);\r\n\t\t\t\t\t\t\t// if (Object.keys(hash).length) {\r\n\t\t\t\t\t\t\t\t// styleOut.common = false;\r\n\t\t\t\t\t\t\t\t// L.extend(attrKeys, hash);\r\n\t\t\t\t\t\t\t// }\r\n\t\t\t\t\t\t\tif (STYLEFUNCKEYS[newKey]) {\r\n\t\t\t\t\t\t\t\t// if (zn.match(/[^\\d\\.]/) === null) {\r\n\t\t\t\t\t\t\t\t\t// zn = Number(zn);\r\n\t\t\t\t\t\t\t\t// } else {\r\n\t\t\t\t\t\t\t\t\t//var func = L.gmx.Parsers.parseExpression(zn);\r\n\t\t\t\t\t\t\t\t\t// if (func === null) {\r\n\t\t\t\t\t\t\t\t\t\t// zn = STYLEFUNCERROR[newKey]();\r\n\t\t\t\t\t\t\t\t\t// } else {\r\n\t\t\t\t\t\t\t\t\t\t// styleOut[STYLEFUNCKEYS[newKey]] = func;\r\n\t\t\t\t\t\t\t\t\t// }\r\n\t\t\t\t\t\t\t\t// }\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} else if (key1 === 'opacity') {\r\n\t\t\t\t\t\t\tzn /= 100;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tstyleOut[newKey] = zn;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (style.marker) {\r\n\t\t\tst = style.marker;\r\n\t\t\tif ('dx' in st || 'dy' in st) {\r\n\t\t\t\tvar dx = st.dx || 0,\r\n\t\t\t\t\tdy = st.dy || 0;\r\n\t\t\t\tstyleOut.iconAnchor = [-dx, -dy];    // For leaflet type iconAnchor\r\n\t\t\t}\r\n\t\t}\r\n\t\tfor (key in style) {\r\n\t\t\tif (!STYLEKEYS[key]) {\r\n\t\t\t\tstyleOut[key] = style[key];\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn styleOut;\r\n/*\r\n\t\treturn {\r\n\t\t\tstyle: styleOut,\t\t\t// стиль\r\n\t\t\t// attrKeys: attrKeys,\t\t\t// используемые поля атрибутов\r\n\t\t\ttype: type\t\t\t\t\t// 'polygon', 'line', 'circle', 'square', 'image'\r\n\t\t};\r\n*/\r\n\t},\r\n\r\n    parseStyles: (prop) => {\r\n        let styles = prop.styles || [],\r\n\t\t\t// attr = prop.tileAttributeIndexes,\r\n            out = styles.map(it => {\r\n\t\t\t\treturn new Promise(resolve => {\r\n\t\t\t\t\tlet data = utils.parseFilter(it.Filter || ''),\r\n\t\t\t\t\t\trenderStyle = it.RenderStyle;\r\n\t\t\t\t\t\t// iconUrl = renderStyle.iconUrl || (renderStyle.marker && renderStyle.marker.image);\r\n\t\t\t\t\tdata.MinZoom = it.MinZoom || MINZOOM;\r\n\t\t\t\t\tdata.MaxZoom = it.MaxZoom || MAXZOOM;\r\n\t\t\t\t\tif (renderStyle) {\r\n\t\t\t\t\t\tdata.renderStyle = utils.decodeOldStyle(renderStyle);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// if (iconUrl) {\r\n\t\t\t\t\t\t// Requests.getBitMap(iconUrl).then(blob => {\r\n\t\t\t\t\t\t\t// console.log('dsddd', blob);\r\n\t\t\t\t\t\t\t// createImageBitmap(blob, {\r\n\t\t\t\t\t\t\t\t// premultiplyAlpha: 'none',\r\n\t\t\t\t\t\t\t\t// colorSpaceConversion: 'none'\r\n\t\t\t\t\t\t\t// }).then(imageBitmap => {\r\n\t\t\t\t\t\t\t\t// data.imageBitmap = imageBitmap;\r\n\t\t\t\t\t\t\t\t// resolve(data);\r\n\t\t\t\t\t\t\t// }).catch(console.warn);\r\n\t\t\t\t\t\t\t// resolve(data);\r\n\t\t\t\t\t\t// });\r\n\t\t\t\t\t// } else {\r\n\t\t\t\t\t\tresolve(data);\r\n\t\t\t\t\t// }\r\n\t\t\t\t\t// return data;\r\n\t\t\t\t})\r\n\t\t\t});\r\n\t\treturn {\r\n\t\t\tstylesPromise: Promise.all(out)\r\n\t\t};\r\n    },\r\n\r\n    parseMetaProps: function(prop) {\r\n        var meta = prop.MetaProperties || {},\r\n            ph = {};\r\n        ph.dataSource = prop.dataSource || prop.LayerID || '';\r\n\t\t[\r\n\t\t\t'srs',\t\t\t\t\t// проекция слоя\r\n\t\t\t'dataSource',\t\t\t// изменить dataSource через MetaProperties\r\n\t\t\t'gmxProxy',\t\t\t\t// установка прокачивалки\r\n\t\t\t'filter',\t\t\t\t// фильтр слоя\r\n\t\t\t'isGeneralized',\t\t// флаг generalization\r\n\t\t\t'isFlatten',\t\t\t// флаг flatten\r\n\t\t\t'multiFilters',\t\t\t// проверка всех фильтров для обьектов слоя\r\n\t\t\t'showScreenTiles',\t\t// показывать границы экранных тайлов\r\n\t\t\t'dateBegin',\t\t\t// фильтр по дате начало периода\r\n\t\t\t'dateEnd',\t\t\t\t// фильтр по дате окончание периода\r\n\t\t\t'shiftX',\t\t\t\t// сдвиг всего слоя\r\n\t\t\t'shiftY',\t\t\t\t// сдвиг всего слоя\r\n\t\t\t'shiftXfield',\t\t\t// сдвиг растров объектов слоя\r\n\t\t\t'shiftYfield',\t\t\t// сдвиг растров объектов слоя\r\n\t\t\t'quicklookPlatform',\t// тип спутника\r\n\t\t\t'quicklookX1',\t\t\t// точки привязки снимка\r\n\t\t\t'quicklookY1',\t\t\t// точки привязки снимка\r\n\t\t\t'quicklookX2',\t\t\t// точки привязки снимка\r\n\t\t\t'quicklookY2',\t\t\t// точки привязки снимка\r\n\t\t\t'quicklookX3',\t\t\t// точки привязки снимка\r\n\t\t\t'quicklookY3',\t\t\t// точки привязки снимка\r\n\t\t\t'quicklookX4',\t\t\t// точки привязки снимка\r\n\t\t\t'quicklookY4'\t\t\t// точки привязки снимка\r\n\t\t].forEach((k) => {\r\n\t\t\tif (k in meta) {\r\n\t\t\t\tph[k] = meta[k].Value || '';\r\n\t\t\t}\r\n\t\t});\r\n\t\tif (ph.gmxProxy && ph.gmxProxy.toLowerCase() === 'true') {\t\t// проверка прокачивалки\r\n\t\t\tph.gmxProxy = GMXPROXY;\r\n\t\t}\r\n\t\tif ('parentLayer' in meta) {\t\t\t\t\t// изменить dataSource через MetaProperties\r\n\t\t\tph.dataSource = meta.parentLayer.Value;\r\n\t\t}\r\n\r\n        return ph;\r\n    },\r\n\r\n    getTileAttributes: function(prop) {\r\n        let tileAttributeIndexes = {},\r\n            tileAttributeTypes = {};\r\n        if (prop.attributes) {\r\n            let attrs = prop.attributes,\r\n                attrTypes = prop.attrTypes || null;\r\n            if (prop.identityField) { tileAttributeIndexes[prop.identityField] = 0; }\r\n            for (let a = 0; a < attrs.length; a++) {\r\n                let key = attrs[a];\r\n                tileAttributeIndexes[key] = a + 1;\r\n                tileAttributeTypes[key] = attrTypes ? attrTypes[a] : 'string';\r\n            }\r\n        }\r\n        return {\r\n            tileAttributeTypes: tileAttributeTypes,\r\n            tileAttributeIndexes: tileAttributeIndexes\r\n        };\r\n    },\r\n\r\n\tgetStyleNum: function(itemArr, layerAttr, zoom) {\r\n\t\tlet indexes = layerAttr.tileAttributeIndexes;\r\n\t\tif (layerAttr.stylesParsed) {\r\n\t\t\tfor (let i = 0, len = layerAttr.stylesParsed.length; i < len; i++) {\r\n\t\t\t\tlet st = layerAttr.stylesParsed[i];\r\n\t\t\t\tif (zoom && (zoom < st.MinZoom || zoom > st.MaxZoom)) { continue; }\r\n\t\t\t\tif (st.filterFun(itemArr, indexes)) { return i; }\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\treturn 0;\r\n\t\t}\r\n\t\treturn -1;\r\n\t}\r\n};\r\n\r\n// const COMPARS = {WrapStyle: 'None', ftc: 'osm', srs: 3857};\r\n\r\n// const chkSignal = (signalName, signals, opt) => {\r\n\t// opt = opt || {};\r\n\t// let sObj = signals[signalName];\r\n\t\r\n\t// if (sObj) { sObj.abort(); }\r\n\t// sObj = signals[signalName] = new AbortController();\r\n\t// sObj.signal.addEventListener('abort', (ev) => console.log('Отмена fetch:', ev));\r\n\t// opt.signal = sObj.signal;\r\n\t// signals[signalName] = sObj;\r\n\t// return opt;\r\n// };\r\n\r\nconst chkHost = (hostName) => {\r\n\tconsole.log('chkVersion:', hostName, hosts);\r\n\tlet hostLayers = hosts[hostName],\r\n\t\tids = hostLayers.ids,\r\n\t\tarr = [];\r\n\r\n\tfor (let name in ids) {\r\n\t\tlet pt = ids[name],\r\n\t\t\tpars = { Name: name, Version: 'v' in pt ? pt.v : -1 };\r\n\t\tif (pt.dateBegin) {\r\n\t\t\tpars.dateBegin = pt.dateBegin;\r\n\t\t}\r\n\t\tif (pt.dateEnd) {\r\n\t\t\tpars.dateEnd = pt.dateEnd;\r\n\t\t}\r\n\t\tarr.push(pars);\r\n\t}\r\n\r\n\treturn Requests.getJson({\r\n\t\turl: '//' + hostName + SCRIPT,\r\n\t\toptions: Requests.chkSignal('chkVersion', hostLayers.signals),\r\n\t\tparamsArr: [Requests.COMPARS, {\r\n\t\t\tlayers: JSON.stringify(arr),\r\n\t\t\tbboxes: JSON.stringify(bbox || [WORLDBBOX]),\r\n\t\t\t// generalizedTiles: false,\r\n\t\t\tzoom: zoom\r\n\t\t}]\r\n\t}).then(json => {\r\n\t\tdelete hostLayers.signals.chkVersion;\r\n\t\treturn json;\r\n\t})\r\n\t.catch(err => {\r\n\t\tconsole.error(err);\r\n\t\t// resolve('');\r\n\t});\r\n};\r\nconst chkVersion = () => {\r\n\tfor (let host in hosts) {\r\n\t\tchkHost(host).then(json => {\r\n\t\t\tif (json.error) {\r\n\t\t\t\tconsole.warn('chkVersion:', json.error);\r\n\t\t\t} else {\r\n\t\t\t\tlet hostLayers = hosts[host],\r\n\t\t\t\t\tids = hostLayers.ids,\r\n\t\t\t\t\tres = json.res;\r\n\t\t\t\tif (res.Status === 'ok' && res.Result) {\r\n\t\t\t\t\tres.Result.forEach(it => {\r\n\t\t\t\t\t\tlet pt = ids[it.name],\r\n\t\t\t\t\t\t\tprops = it.properties;\r\n\t\t\t\t\t\tif (props) {\r\n\t\t\t\t\t\t\tpt.v = props.LayerVersion;\r\n\t\t\t\t\t\t\tpt.properties = props;\r\n\t\t\t\t\t\t\tpt.geometry = it.geometry;\r\n\t\t\t\t\t\t\tif (!pt.tileAttributeIndexes) {\r\n\t\t\t\t\t\t\t\tRequests.extend(pt, utils.getTileAttributes(props));\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tpt.hostName = host;\r\n\t\t\t\t\t\tpt.tiles = it.tiles;\r\n\t\t\t\t\t\tpt.tilesOrder = it.tilesOrder;\r\n\t\t\t\t\t\t// pt.tilesPromise = \r\n\t\t\t\t\t\tTilesLoader.load(pt);\r\n\t\t\t\t\t\tPromise.all(Object.values(pt.tilesPromise)).then((res) => {\r\n\t\t\t\tconsole.log('tilesPromise ___:', hosts, res);\r\n\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\t// pt.tilesPromise.then(res => {\r\n\t\t\t\t// console.log('tilesPromise ___:', hosts, res);\r\n\t\t\t\t\t\t// });\r\n\t\t\t\t// console.log('chkVersion ___:', pt);\r\n\t\t\t\t\t});\r\n\t\t\t\t\t// resolve(res.Result.Key !== 'null' ? '' : res.Result.Key);\r\n\t\t\t\t// } else {\r\n\t\t\t\t\t// reject(json);\r\n\t\t\t\t\t// console.log('chkVersion key:', host, hosts);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n};\r\n\r\nconst addSource = (pars) => {\r\n\tpars = pars || {};\r\n\r\n\tlet id = pars.id;\r\n\t\r\n\tif ('zoom' in pars) { zoom = pars.zoom; }\r\n\tif ('bbox' in pars) { bbox = pars.bbox; }\r\n\t\t\r\n\tif (id) {\r\n\t\tlet hostName = pars.hostName || HOST;\r\n\t\tif (!hosts[hostName]) {\r\n\t\t\thosts[hostName] = {ids: {}, signals: {}};\r\n\t\t\tif (pars.apiKey) {\r\n\t\t\t\thosts[hostName].apiKeyPromise = Requests.getJson({\r\n\t\t\t\t\turl: '//' + hostName + '/ApiKey.ashx',\r\n\t\t\t\t\tparamsArr: [Requests.COMPARS, {\r\n\t\t\t\t\t\tKey: pars.apiKey\r\n\t\t\t\t\t}]\r\n\t\t\t\t}).then((json) => {\r\n\t\t\t\t\t// console.log('/ApiKey.ashx', json);\r\n\t\t\t\t\tlet res = json.res;\r\n\t\t\t\t\tif (res.Status === 'ok' && res.Result) {\r\n\t\t\t\t\t\thosts[hostName].Key = res.Result.Key;\r\n\t\t\t\t\t\treturn hosts[hostName].Key;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t\thosts[hostName].ids[id] = pars;\r\n        if (!intervalID) { utils.start(); }\r\n\t\tutils.now();\r\n\t} else {\r\n\t\tconsole.warn('Warning: Specify layer `id` and `hostName`', pars);\r\n\t}\r\n\tif (pars.vid) {\r\n\t\tlet linkAttr = hosts[pars.vHostName || HOST].parseLayers.layersByID[pars.vid];\r\n\t\tRequests.extend(linkAttr, utils.parseStyles(linkAttr.properties));\r\n\t\tlinkAttr.stylesPromise.then((res) => {\r\n\t\t\tlinkAttr.styles = res;\r\n\t\t});\r\n\t}\r\n\r\n// console.log('addSource:', pars);\r\n\treturn;\r\n};\r\n\r\nconst removeSource = (pars) => {\r\n\tpars = pars || {};\r\n\r\n\tlet id = pars.id;\r\n\tif (id) {\r\n\t\tlet hostName = pars.hostName || HOST;\r\n\t\tif (hosts[hostName]) {\r\n\t\t\tlet pt = hosts[hostName].ids[id];\r\nconsole.log('signals:', pt.signals, pt);\r\n\t\t\tif (pt.signals) {\r\n\t\t\t\tObject.values(pt.signals).forEach((it) => {\r\n\t\t\t\t\tit.abort();\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tdelete hosts[hostName].ids[id];\r\n\t\t\tif (Object.keys(hosts[hostName].ids).length === 0) { delete hosts[hostName]; }\r\n\t\t\tif (Object.keys(hosts).length === 0) { utils.stop(); }\r\n\t\t}\r\n\t} else {\r\n\t\tconsole.warn('Warning: Specify layer id and hostName', pars);\r\n\t}\r\n// console.log('removeSource:', pars);\r\n\t//Requests.removeDataSource({id: message.layerID, hostName: message.hostName}).then((json) => {\r\n\treturn;\r\n};\r\n\r\nconst moveend = (pars) => {\r\n\tpars = pars || {};\r\nconsole.log('moveend:', pars);\r\n\t\r\n\tif ('zoom' in pars) { zoom = pars.zoom; }\r\n\tif ('bbox' in pars) { bbox = pars.bbox; }\r\n\t\t\r\n\tutils.now();\r\n\treturn;\r\n};\r\nconst setDateInterval = (pars) => {\r\n\tpars = pars || {};\r\n\tlet host = hosts[pars.hostName];\r\n\tif (host && host.ids[pars.id]) {\r\n\t\thost.ids[pars.id].dateBegin = pars.dateBegin;\r\n\t\thost.ids[pars.id].dateEnd = pars.dateEnd;\r\n\t}\r\n\tutils.now();\r\n\r\nconsole.log('setDateInterval:', pars, hosts);\r\n};\r\n\r\nconst _iterateNodeChilds = (node, level, out) => {\r\n\tlevel = level || 0;\r\n\tout = out || {\r\n\t\tlayers: [],\r\n\t\tlayersByID: {}\r\n\t};\r\n\t\r\n\tif (node) {\r\n\t\tlet type = node.type,\r\n\t\t\tcontent = node.content,\r\n\t\t\tprops = content.properties;\r\n\t\tif (type === 'layer') {\r\n\t\t\tlet ph = {\r\n\t\t\t\tproperties: props,\r\n\t\t\t\tlevel: level\r\n\t\t\t};\r\n\t\t\t// let ph = utils.parseLayerProps(props);\r\n\t\t\t// ph.level = level;\r\n\t\t\tif (content.geometry) { ph.geometry = content.geometry; }\r\n\t\t\tout.layers.push(ph);\r\n\t\t\tout.layersByID[props.name] = ph;\r\n\t\t} else if (type === 'group') {\r\n\t\t\tlet childs = content.children || [];\r\n\t\t\tout.layers.push({ level: level, group: true, childsLen: childs.length, properties: props });\r\n\t\t\tchilds.map((it) => {\r\n\t\t\t\t_iterateNodeChilds(it, level + 1, out);\r\n\t\t\t});\r\n\t\t}\r\n\t\t\r\n\t} else {\r\n\t\treturn out;\r\n\t}\r\n\treturn out;\r\n};\r\n\r\nconst parseTree = (json) => {\r\n\tlet out = {};\r\n\tif (json.Status === 'error') {\r\n\t\tout = json;\r\n\t} else if (json.Result && json.Result.content) {\r\n\t\tout = _iterateNodeChilds(json.Result);\r\n\t\tout.mapAttr = out.layers.shift();\r\n\t}\r\n// console.log('______json_out_______', out, json)\r\n\treturn out;\r\n};\r\n\r\nconst getMapTree = (pars) => {\r\n\tpars = pars || {};\r\n\tlet hostName = pars.hostName || HOST,\r\n\t\thost = hosts[hostName];\r\n\r\n\treturn new Promise((resolve) => {\r\n\t\tif (host && host.layerTree) {\r\n\t\t\tresolve(host.layerTree);\r\n\t\t} else {\r\n\t\t\tRequests.getJson({\r\n\t\t\t\turl: '//' + hostName + '/Map/GetMapFolder',\r\n\t\t\t\t// options: {},\r\n\t\t\t\tparams: {\r\n\t\t\t\t\tsrs: 3857, \r\n\t\t\t\t\tskipTiles: 'All',\r\n\t\t\t\t\tmapId: pars.mapID,\r\n\t\t\t\t\tfolderId: 'root',\r\n\t\t\t\t\tvisibleItemOnly: false\r\n\t\t\t\t}\r\n\t\t\t}).then(json => {\r\n\t\t\t\tif (!hosts[hostName]) { hosts[hostName] = {ids: {}, signals: {}}; }\r\n console.log('getMapTree:', hosts, json);\r\n\t\t\t\tresolve(json);\r\n\t\t\t\thosts[hostName].layerTree = json.res.Result;\r\n\t\t\t\thosts[hostName].parseLayers = parseTree(json.res);\r\n\t\t\t})\r\n\t\t}\r\n\t});\r\n};\r\n\r\nexport default {\r\n\tgetMapTree,\r\n\tsetDateInterval,\r\n\tmoveend,\r\n\tremoveSource,\r\n\taddSource\r\n};","import Requests from './Requests.js';\r\nimport DataVersion from './DataSourceVersion';\r\n\r\nvar _self = self;\r\n(_self.on || _self.addEventListener).call(_self, 'message', e => {\r\n    const message = e.data || e;\r\nconsole.log('message ', e);\r\n    switch (message.cmd) {\r\n\t\tcase 'getLayerItems':\r\n\t\t\tRequests.getLayerItems({layerID: message.layerID}).then((json) => {\r\n\t\t\t\tmessage.out = json;\r\n\t\t\t\tlet pt = {};\r\n\t\t\t\tjson.Result.fields.forEach((name, i) => { pt[name] = i; });\r\n\t\t\t\tjson.Result.fieldKeys = pt;\r\n\t\t\t\t_self.postMessage(message);\r\n\t\t\t});\r\n\t\t\tbreak;\r\n\t\tcase 'getMap':\r\n\t\t\tDataVersion.getMapTree({mapID: message.mapID, hostName: message.hostName, search: message.search}).then((json) => {\r\n\t\t\t// Requests.getMapTree({mapID: message.mapID, hostName: message.hostName, search: message.search}).then((json) => {\r\n\t\t\t\tmessage.out = json;\r\n\t\t\t\t_self.postMessage(message);\r\n\t\t\t});\r\n\t\t\tbreak;\r\n\t\tcase 'setSyncParams':\r\n\t\t\tRequests.setSyncParams(message.syncParams);\r\n\t\t\tbreak;\r\n\t\tcase 'getSyncParams':\r\n\t\t\tmessage.syncParams = Requests.getSyncParams(message.stringFlag);\r\n\t\t\t_self.postMessage(message);\r\n\t\t\tbreak;\r\n\t\tcase 'addDataSource':\r\n\t\t\tDataVersion.addSource(message);\r\n\t\t\t// .then((json) => {\r\n\t\t\t\t// message.out = json;\r\n\t\t\t\t// _self.postMessage(message);\r\n\t\t\t// });\r\n\t\t\tbreak;\r\n\t\tcase 'removeDataSource':\r\n\t\t\tDataVersion.removeSource({id: message.id, hostName: message.hostName});\r\n\t\t\tbreak;\r\n\t\tcase 'setDateInterval':\r\n\t\t\tDataVersion.setDateInterval(message);\r\n\t\t\tbreak;\r\n\t\tcase 'moveend':\r\n\t\t\tDataVersion.moveend(message);\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\tconsole.warn('Неизвестная команда:', message.cmd);\r\n\t\t\tbreak;\r\n\t}\r\n});\r\n\r\n"],"names":["_self","self","window","str","location","origin","_protocol","substring","indexOf","syncParams","fetchOptions","mode","credentials","COMPARS","WrapStyle","ftc","srs","setSyncParams","hash","getSyncParams","stringFlag","res","arr","key","push","join","parseURLParams","sp","URLSearchParams","search","out","p","k","z","main","keys","utils","extend","dest","i","j","len","src","arguments","length","makeTileKeys","it","ptiles","tklen","tilesOrder","tiles","newTiles","t","splice","tk","tile","data","tp","x","y","v","s","d","getZoomRange","info","properties","styles","st","Math","min","MinZoom","max","MaxZoom","chkProtocol","url","substr","getFormBody","par","Object","map","encodeURIComponent","chkResponse","resp","type","status","Promise","reject","contentType","headers","get","blob","json","text","getBitMap","options","fetch","then","getTileJson","queue","params","paramsArr","forEach","getJson","opt","method","body","load","catch","err","error","toString","chkSignal","signalName","signals","sObj","abort","AbortController","signal","addEventListener","ev","console","log","TILE_PREFIX","pars","tilesPromise","pb","slice","tkey","tHash","reduce","c","Requests","hostName","r","ModeKey","LayerName","id","replace","JSON","parse","HOST","WORLDWIDTHFULL","W","WORLDBBOX","SCRIPT","GMXPROXY","MINZOOM","MAXZOOM","STYLEKEYS","marker","server","client","outline","fill","label","hosts","zoom","bbox","delay","intervalID","timeoutID","now","clearTimeout","setTimeout","chkVersion","stop","clearInterval","start","msec","setInterval","parseFilter","regex1","regex2","regexMath","filter","filterParsed","filterFun","Function","legend","decodeOldStyle","style","key1","styleOut","newKey","zn","dx","dy","iconAnchor","parseStyles","prop","resolve","Filter","renderStyle","RenderStyle","stylesPromise","all","parseMetaProps","meta","MetaProperties","ph","dataSource","LayerID","Value","gmxProxy","toLowerCase","parentLayer","getTileAttributes","tileAttributeIndexes","tileAttributeTypes","attributes","attrs","attrTypes","identityField","a","getStyleNum","itemArr","layerAttr","indexes","stylesParsed","chkHost","hostLayers","ids","name","pt","Name","Version","dateBegin","dateEnd","layers","stringify","bboxes","host","warn","Status","Result","props","LayerVersion","geometry","TilesLoader","values","addSource","apiKey","apiKeyPromise","Key","vid","linkAttr","vHostName","parseLayers","layersByID","removeSource","moveend","setDateInterval","_iterateNodeChilds","node","level","content","childs","children","group","childsLen","parseTree","mapAttr","shift","getMapTree","layerTree","skipTiles","mapId","mapID","folderId","visibleItemOnly","on","call","e","message","cmd","getLayerItems","layerID","fields","fieldKeys","postMessage","DataVersion"],"mappings":"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"}