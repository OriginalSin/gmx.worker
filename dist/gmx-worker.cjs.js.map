{"version":3,"file":"index.js","sources":["../scripts/WorkerLoaderHelper.js","../src/worker/Requests.js","../src/index.js"],"sourcesContent":["const kIsNodeJS = Object.prototype.toString.call(typeof process !== 'undefined' ? process : 0) === '[object process]'; // eslint-disable-line\nconst kRequire = kIsNodeJS ? module.require : null; // eslint-disable-line\n\nexport function createInlineWorkerFactory(fn, sourcemap = null) {\n    const source = fn.toString();\n    const start = source.indexOf('\\n', 10) + 1;\n    const end = source.indexOf('}', source.length - 1);\n    const body = source.substring(start, end) + (sourcemap ? `//# sourceMappingURL=${sourcemap}` : '');\n    const blankPrefixLength = body.search(/\\S/);\n    const lines = body.split('\\n').map(line => line.substring(blankPrefixLength) + '\\n');\n\n    if (kIsNodeJS) {\n        /* node.js */\n        const Worker = kRequire('worker_threads').Worker; // eslint-disable-line\n        const concat = lines.join('\\n');\n        return function WorkerFactory(options) {\n            return new Worker(concat, Object.assign({}, options, { eval: true }));\n        };\n    }\n\n    /* browser */\n    const blob = new Blob(lines, { type: 'application/javascript' });\n    const url = URL.createObjectURL(blob);\n    return function WorkerFactory(options) {\n        return new Worker(url, options);\n    };\n}\n\nexport function createURLWorkerFactory(url) {\n    if (kIsNodeJS) {\n        /* node.js */\n        const Worker = kRequire('worker_threads').Worker; // eslint-disable-line\n        return function WorkerFactory(options) {\n            return new Worker(url, options);\n        };\n    }\n    /* browser */\n    return function WorkerFactory(options) {\n        return new Worker(url, options);\n    };\n}\n\nexport function createBase64WorkerFactory(base64, sourcemap = null) {\n    const source = kIsNodeJS ? Buffer.from(base64, 'base64').toString('ascii') : atob(base64); // eslint-disable-line\n    const start = source.indexOf('\\n', 10) + 1;\n    const body = source.substring(start) + (sourcemap ? `//# sourceMappingURL=${sourcemap}` : '');\n\n    if (kIsNodeJS) {\n        /* node.js */\n        const Worker = kRequire('worker_threads').Worker; // eslint-disable-line\n        return function WorkerFactory(options) {\n            return new Worker(body, Object.assign({}, options, { eval: true }));\n        };\n    }\n\n    /* browser */\n    const blob = new Blob([body], { type: 'application/javascript' });\n    const url = URL.createObjectURL(blob);\n    return function WorkerFactory(options) {\n        return new Worker(url, options);\n    };\n}\n","\r\nconst\t_self = self || window,\r\n\t\tserverBase = _self.serverBase || 'maps.kosmosnimki.ru/',\r\n\t\t// serverProxy = serverBase + 'Plugins/ForestReport/proxy',\r\n\t\tgmxProxy = '//maps.kosmosnimki.ru/ApiSave.ashx';\r\n\r\n// let _app = {},\r\n\t// loaderStatus = {},\r\n\t// _sessionKeys = {},\r\nlet str = self.location.origin || '',\r\n\t_protocol = str.substring(0, str.indexOf('/')),\r\n\tsyncParams = {},\r\n\tfetchOptions = {\r\n\t\t// method: 'post',\r\n\t\t// headers: {'Content-type': 'application/x-www-form-urlencoded'},\r\n\t\tmode: 'cors',\r\n\t\tredirect: 'follow',\r\n\t\tcredentials: 'include'\r\n\t};\r\n\r\nconst COMPARS = {WrapStyle: 'None', ftc: 'osm', srs: 3857};\r\n\r\nconst setSyncParams = (hash) => {\t// установка дополнительных параметров для серверных запросов\r\n\tsyncParams = hash;\r\n};\r\nconst getSyncParams = (stringFlag) => {\r\n\tvar res = syncParams;\r\n\tif (stringFlag) {\r\n\t\tvar arr = [];\r\n\t\tfor (var key in res) {\r\n\t\t\tarr.push(key + '=' + res[key]);\r\n\t\t}\r\n\t\tres = arr.join('&');\r\n\t}\r\n\treturn res;\r\n};\r\n\r\nconst parseURLParams = (str) => {\r\n\tlet sp = new URLSearchParams(str || location.search),\r\n\t\tout = {},\r\n\t\tarr = [];\r\n\tfor (let p of sp) {\r\n\t\tlet k = p[0], z = p[1];\r\n\t\tif (z) {\r\n\t\t\tif (!out[k]) {out[k] = [];}\r\n\t\t\tout[k].push(z);\r\n\t\t} else {\r\n\t\t\tarr.push(k);\r\n\t\t}\r\n\t}\r\n\treturn {main: arr, keys: out};\r\n};\r\nlet utils = {\r\n\textend: function (dest) {\r\n\t\tvar i, j, len, src;\r\n\r\n\t\tfor (j = 1, len = arguments.length; j < len; j++) {\r\n\t\t\tsrc = arguments[j];\r\n\t\t\tfor (i in src) {\r\n\t\t\t\tdest[i] = src[i];\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn dest;\r\n\t},\r\n\r\n\tmakeTileKeys: function(it, ptiles) {\r\n\t\tvar tklen = it.tilesOrder.length,\r\n\t\t\tarr = it.tiles,\r\n\t\t\ttiles = {},\r\n\t\t\tnewTiles = {};\r\n\r\n\t\twhile (arr.length) {\r\n\t\t\tvar t = arr.splice(0, tklen),\r\n\t\t\t\ttk = t.join('_'),\r\n\t\t\t\ttile = ptiles[tk];\r\n\t\t\tif (!tile || !tile.data) {\r\n\t\t\t\tif (!tile) {\r\n\t\t\t\t\ttiles[tk] = {\r\n\t\t\t\t\t\ttp: {z: t[0], x: t[1], y: t[2], v: t[3], s: t[4], d: t[5]}\r\n\t\t\t\t\t};\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttiles[tk] = tile;\r\n\t\t\t\t}\r\n\t\t\t\tnewTiles[tk] = true;\r\n\t\t\t} else {\r\n\t\t\t\ttiles[tk] = tile;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn {tiles: tiles, newTiles: newTiles};\r\n\t},\r\n\r\n\tgetZoomRange: function(info) {\r\n\t\tvar arr = info.properties.styles,\r\n\t\t\tout = [40, 0];\r\n\t\tfor (var i = 0, len = arr.length; i < len; i++) {\r\n\t\t\tvar st = arr[i];\r\n\t\t\tout[0] = Math.min(out[0], st.MinZoom);\r\n\t\t\tout[1] = Math.max(out[1], st.MaxZoom);\r\n\t\t}\r\n\t\tout[0] = out[0] === 40 ? 1 : out[0];\r\n\t\tout[1] = out[1] === 0 ? 22 : out[1];\r\n\t\treturn out;\r\n\t},\r\n\r\n\tchkProtocol: function(url) {\r\n\t\treturn url.substr(0, _protocol.length) === _protocol ? url : _protocol + url;\r\n\t},\r\n\tgetFormBody: function(par) {\r\n\t\treturn Object.keys(par).map(function(key) { return encodeURIComponent(key) + '=' + encodeURIComponent(par[key]); }).join('&');\r\n\t},\r\n\tchkResponse: function(resp, type) {\r\n\t\tif (resp.status < 200 || resp.status >= 300) {\t\t\t\t\t\t// error\r\n\t\t\treturn Promise.reject(resp);\r\n\t\t} else {\r\n\t\t\tvar contentType = resp.headers.get('Content-Type');\r\n\t\t\tif (type === 'bitmap') {\t\t\t\t\t\t\t\t\t\t\t\t// get blob\r\n\t\t\t\treturn resp.blob();\r\n\t\t\t} else if (contentType.indexOf('application/json') > -1) {\t\t\t\t// application/json; charset=utf-8\r\n\t\t\t\treturn resp.json();\r\n\t\t\t} else if (contentType.indexOf('text/javascript') > -1) {\t \t\t\t// text/javascript; charset=utf-8\r\n\t\t\t\treturn resp.text();\r\n\t\t\t// } else if (contentType.indexOf('application/json') > -1) {\t \t\t// application/json; charset=utf-8\r\n\t\t\t\t// ret = resp.text();\r\n\t\t\t// } else if (contentType.indexOf('application/json') > -1) {\t \t\t// application/json; charset=utf-8\r\n\t\t\t\t// ret = resp.formData();\r\n\t\t\t// } else if (contentType.indexOf('application/json') > -1) {\t \t\t// application/json; charset=utf-8\r\n\t\t\t\t// ret = resp.arrayBuffer();\r\n\t\t\t// } else {\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn resp.text();\r\n\t},\r\n\t// getJson: function(url, params, options) {\r\n\tgetJson: function(queue) {\r\n// log('getJson', _protocol, queue, Date.now())\r\n\t\tlet params = queue.params || {};\r\n\t\tif (queue.paramsArr) {\r\n\t\t\tqueue.paramsArr.forEach((it) => {\r\n\t\t\t\tparams = utils.extend(params, it);\r\n\t\t\t});\r\n\t\t}\r\n\t\tlet par = utils.extend({}, params, syncParams),\r\n\t\t\toptions = queue.options || {},\r\n\t\t\topt = utils.extend({\r\n\t\t\t\tmethod: 'post',\r\n\t\t\t\theaders: {'Content-type': 'application/x-www-form-urlencoded'}\r\n\t\t\t\t// mode: 'cors',\r\n\t\t\t\t// redirect: 'follow',\r\n\t\t\t\t// credentials: 'include'\r\n\t\t\t}, fetchOptions, options, {\r\n\t\t\t\tbody: utils.getFormBody(par)\r\n\t\t\t});\r\n\t\treturn fetch(utils.chkProtocol(queue.url), opt)\r\n\t\t.then(function(res) {\r\n\t\t\treturn utils.chkResponse(res, options.type);\r\n\t\t})\r\n\t\t.then(function(res) {\r\n\t\t\tvar out = {url: queue.url, queue: queue, load: true, res: res};\r\n\t\t\t// if (queue.send) {\r\n\t\t\t\t// handler.workerContext.postMessage(out);\r\n\t\t\t// } else {\r\n\t\t\t\treturn out;\r\n\t\t\t// }\r\n\t\t})\r\n\t\t.catch(function(err) {\r\n\t\t\treturn {url: queue.url, queue: queue, load: false, error: err.toString()};\r\n\t\t\t// handler.workerContext.postMessage(out);\r\n\t\t});\r\n    },\r\n    parseLayerProps: function(prop) {\r\n\t\t// let ph = utils.getTileAttributes(prop);\r\n\t\treturn utils.extend(\r\n\t\t\t{\r\n\t\t\t\tproperties: prop\r\n\t\t\t},\r\n\t\t\tutils.getTileAttributes(prop),\r\n\t\t\tutils.parseMetaProps(prop)\r\n\t\t);\r\n\t\t\r\n\t\t\r\n\t\t// return ph;\r\n    },\r\n\r\n    parseMetaProps: function(prop) {\r\n        var meta = prop.MetaProperties || {},\r\n            ph = {};\r\n        ph.dataSource = prop.dataSource || prop.LayerID;\r\n\t\tif ('parentLayer' in meta) {\t\t\t\t\t\t\t\t// изменить dataSource через MetaProperties\r\n\t\t\tph.dataSource = meta.parentLayer.Value || '';\r\n\t\t}\r\n\t\t[\r\n\t\t\t'srs',\t\t\t\t\t// проекция слоя\r\n\t\t\t'gmxProxy',\t\t\t\t// установка прокачивалки\r\n\t\t\t'filter',\t\t\t\t// фильтр слоя\r\n\t\t\t'isGeneralized',\t\t// флаг generalization\r\n\t\t\t'isFlatten',\t\t\t// флаг flatten\r\n\t\t\t'multiFilters',\t\t\t// проверка всех фильтров для обьектов слоя\r\n\t\t\t'showScreenTiles',\t\t// показывать границы экранных тайлов\r\n\t\t\t'dateBegin',\t\t\t// фильтр по дате начало периода\r\n\t\t\t'dateEnd',\t\t\t\t// фильтр по дате окончание периода\r\n\t\t\t'shiftX',\t\t\t\t// сдвиг всего слоя\r\n\t\t\t'shiftY',\t\t\t\t// сдвиг всего слоя\r\n\t\t\t'shiftXfield',\t\t\t// сдвиг растров объектов слоя\r\n\t\t\t'shiftYfield',\t\t\t// сдвиг растров объектов слоя\r\n\t\t\t'quicklookPlatform',\t// тип спутника\r\n\t\t\t'quicklookX1',\t\t\t// точки привязки снимка\r\n\t\t\t'quicklookY1',\t\t\t// точки привязки снимка\r\n\t\t\t'quicklookX2',\t\t\t// точки привязки снимка\r\n\t\t\t'quicklookY2',\t\t\t// точки привязки снимка\r\n\t\t\t'quicklookX3',\t\t\t// точки привязки снимка\r\n\t\t\t'quicklookY3',\t\t\t// точки привязки снимка\r\n\t\t\t'quicklookX4',\t\t\t// точки привязки снимка\r\n\t\t\t'quicklookY4'\t\t\t// точки привязки снимка\r\n\t\t].forEach((k) => {\r\n\t\t\tph[k] = k in meta ? meta[k].Value : '';\r\n\t\t});\r\n\t\tif (ph.gmxProxy.toLowerCase() === 'true') {    // проверка прокачивалки\r\n\t\t\tph.gmxProxy = gmxProxy;\r\n\t\t}\r\n\t\tif ('parentLayer' in meta) {  // фильтр слоя\t\t// todo удалить после изменений вов вьювере\r\n\t\t\tph.dataSource = meta.parentLayer.Value || prop.dataSource || '';\r\n\t\t}\r\n\r\n        return ph;\r\n    },\r\n\r\n    getTileAttributes: function(prop) {\r\n        var tileAttributeIndexes = {},\r\n            tileAttributeTypes = {};\r\n        if (prop.attributes) {\r\n            var attrs = prop.attributes,\r\n                attrTypes = prop.attrTypes || null;\r\n            if (prop.identityField) { tileAttributeIndexes[prop.identityField] = 0; }\r\n            for (var a = 0; a < attrs.length; a++) {\r\n                var key = attrs[a];\r\n                tileAttributeIndexes[key] = a + 1;\r\n                tileAttributeTypes[key] = attrTypes ? attrTypes[a] : 'string';\r\n            }\r\n        }\r\n        return {\r\n            tileAttributeTypes: tileAttributeTypes,\r\n            tileAttributeIndexes: tileAttributeIndexes\r\n        };\r\n    }\r\n};\r\n/*\r\nconst requestSessionKey = (serverHost, apiKey) => {\r\n\tlet keys = _sessionKeys;\r\n\tif (!(serverHost in keys)) {\r\n\t\tkeys[serverHost] = new Promise(function(resolve, reject) {\r\n\t\t\tif (apiKey) {\r\n\t\t\t\tutils.getJson({\r\n\t\t\t\t\turl: '//' + serverHost + '/ApiKey.ashx',\r\n\t\t\t\t\tparams: {WrapStyle: 'None', Key: apiKey}\r\n\t\t\t\t})\r\n\t\t\t\t\t.then(function(json) {\r\n\t\t\t\t\t\tlet res = json.res;\r\n\t\t\t\t\t\tif (res.Status === 'ok' && res.Result) {\r\n\t\t\t\t\t\t\tresolve(res.Result.Key !== 'null' ? '' : res.Result.Key);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\treject(json);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.catch(function() {\r\n\t\t\t\t\t\tresolve('');\r\n\t\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tresolve('');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\treturn keys[serverHost];\r\n};\r\nlet _maps = {};\r\nconst getMapTree = (pars) => {\r\n\tpars = pars || {};\r\n\tlet hostName = pars.hostName || serverBase,\r\n\t\tid = pars.mapId;\r\n\treturn utils.getJson({\r\n\t\turl: '//' + hostName + '/Map/GetMapFolder',\r\n\t\t// options: {},\r\n\t\tparams: {\r\n\t\t\tsrs: 3857, \r\n\t\t\tskipTiles: 'All',\r\n\r\n\t\t\tmapId: id,\r\n\t\t\tfolderId: 'root',\r\n\t\t\tvisibleItemOnly: false\r\n\t\t}\r\n\t})\r\n\t\t.then(function(json) {\r\n\t\t\tlet out = parseTree(json.res);\r\n\t\t\t_maps[hostName] = _maps[hostName] || {};\r\n\t\t\t_maps[hostName][id] = out;\r\n\t\t\treturn parseTree(out);\r\n\t\t});\r\n};\r\nconst getReq = url => {\r\n\treturn fetch(url, {\r\n\t\t\tmethod: 'get',\r\n\t\t\tmode: 'cors',\r\n\t\t\tcredentials: 'include'\r\n\t\t// headers: {'Accept': 'application/json'},\r\n\t\t// body: JSON.stringify(params)\t// TODO: сервер почему то не хочет работать так https://googlechrome.github.io/samples/fetch-api/fetch-post.html\r\n\t\t})\r\n\t\t.then(res => res.json())\r\n\t\t.catch(err => console.warn(err));\r\n};\r\n\r\n// const getLayerItems = (params) => {\r\n\t// params = params || {};\r\n\r\n\t// let url = `${serverBase}VectorLayer/Search.ashx`;\r\n\t// url += '?layer=' + params.layerID;\r\n\t// if (params.id) { '&query=gmx_id=' + params.id; }\r\n\r\n\t// url += '&out_cs=EPSG:4326';\r\n\t// url += '&geometry=true';\r\n\t// return getReq(url);\r\n// };\r\n// const getReportsCount = () => {\r\n\t// return getReq(serverProxy + '?path=/rest/v1/get-current-user-info');\r\n// };\r\n\r\nlet dataSources = {},\r\n\tloaderStatus1 = {};\r\n\r\nconst addDataSource = (pars) => {\r\n\tpars = pars || {};\r\n\r\n\tlet id = pars.id;\r\n\tif (id) {\r\n\t\tlet hostName = pars.hostName;\r\n\t\t\r\n\t} else {\r\n\t\tconsole.warn('Warning: Specify layer \\'id\\' and \\'hostName\\`', pars);\r\n\t}\r\nconsole.log('addDataSource:', pars);\r\n\treturn;\r\n};\r\n\r\nconst removeDataSource = (pars) => {\r\n\tpars = pars || {};\r\n\r\n\tlet id = pars.id;\r\n\tif (id) {\r\n\t\tlet hostName = pars.hostName;\r\n\t\t\r\n\t} else {\r\n\t\tconsole.warn('Warning: Specify layer \\'id\\' and \\'hostName\\`', pars);\r\n\t}\r\nconsole.log('removeDataSource:', pars);\r\n\t//Requests.removeDataSource({id: message.layerID, hostName: message.hostName}).then((json) => {\r\n\treturn;\r\n};\r\n*/\r\nlet _maps = {};\r\nconst getMapTree = (pars) => {\r\n\tpars = pars || {};\r\n\tlet hostName = pars.hostName || serverBase,\r\n\t\tid = pars.mapId;\r\n\treturn utils.getJson({\r\n\t\turl: '//' + hostName + '/Map/GetMapFolder',\r\n\t\t// options: {},\r\n\t\tparams: {\r\n\t\t\tsrs: 3857, \r\n\t\t\tskipTiles: 'All',\r\n\r\n\t\t\tmapId: id,\r\n\t\t\tfolderId: 'root',\r\n\t\t\tvisibleItemOnly: false\r\n\t\t}\r\n\t})\r\n\t\t.then(function(json) {\r\n\t\t\tlet out = parseTree(json.res);\r\n\t\t\t_maps[hostName] = _maps[hostName] || {};\r\n\t\t\t_maps[hostName][id] = out;\r\n\t\t\treturn parseTree(out);\r\n\t\t});\r\n};\r\n\r\nconst _iterateNodeChilds = (node, level, out) => {\r\n\tlevel = level || 0;\r\n\tout = out || {\r\n\t\tlayers: []\r\n\t};\r\n\t\r\n\tif (node) {\r\n\t\tlet type = node.type,\r\n\t\t\tcontent = node.content,\r\n\t\t\tprops = content.properties;\r\n\t\tif (type === 'layer') {\r\n\t\t\tlet ph = utils.parseLayerProps(props);\r\n\t\t\tph.level = level;\r\n\t\t\tif (content.geometry) { ph.geometry = content.geometry; }\r\n\t\t\tout.layers.push(ph);\r\n\t\t} else if (type === 'group') {\r\n\t\t\tlet childs = content.children || [];\r\n\t\t\tout.layers.push({ level: level, group: true, childsLen: childs.length, properties: props });\r\n\t\t\tchilds.map((it) => {\r\n\t\t\t\t_iterateNodeChilds(it, level + 1, out);\r\n\t\t\t});\r\n\t\t}\r\n\t\t\r\n\t} else {\r\n\t\treturn out;\r\n\t}\r\n\treturn out;\r\n};\r\n\r\nconst parseTree = (json) => {\r\n\tlet out = {};\r\n\tif (json.Status === 'error') {\r\n\t\tout = json;\r\n\t} else if (json.Result && json.Result.content) {\r\n\t\tout = _iterateNodeChilds(json.Result);\r\n\t\tout.mapAttr = out.layers.shift();\r\n\t}\r\n// console.log('______json_out_______', out, json)\r\n\treturn out;\r\n};\r\n\r\n\r\nconst chkSignal = (signalName, signals, opt) => {\r\n\topt = opt || {};\r\n\tlet sObj = signals[signalName];\r\n\t\r\n\tif (sObj) { sObj.abort(); }\r\n\tsObj = signals[signalName] = new AbortController();\r\n\tsObj.signal.addEventListener('abort', (ev) => console.log('Отмена fetch:', ev));\r\n\topt.signal = sObj.signal;\r\n\tsignals[signalName] = sObj;\r\n\treturn opt;\r\n};\r\n\r\nexport default {\r\n\tchkSignal,\r\n\tCOMPARS,\r\n\tsetSyncParams,\r\n\tgetSyncParams,\r\n\tparseURLParams,\r\n\tgetMapTree,\r\n\tgetJson: utils.getJson\r\n\t// addDataSource,\r\n\t// removeDataSource,\r\n\t// getReportsCount,\r\n\t// getLayerItems\r\n};","import DataWorker from 'web-worker:./worker';\r\nimport Requests from './worker/Requests.js';\r\nimport L from 'leaflet';\r\n\r\nconst dataWorker = new DataWorker();\nconst urlPars = Requests.parseURLParams();\n\t\tconsole.log('urlPars', urlPars);\n\r\nconst WORLDWIDTHFULL = 40075016.685578496,\r\n\tW = WORLDWIDTHFULL / 2,\r\n\t// WORLDBBOX = JSON.stringify([[-W, -W, W, W]]);\r\n\tWORLDBBOX = [[-W, -W, W, W]];\r\n//dataWorker.postMessage('Hello World!');\r\nconst Utils = {\r\n\tgetBboxes: function(map) {\r\n\t\tif (map.options.allWorld) {\r\n\t\t\treturn WORLDBBOX;\r\n\t\t}\r\n\t\tlet bbox = map.getBounds(),\r\n\t\t\tne = bbox.getNorthEast(),\r\n\t\t\tsw = bbox.getSouthWest();\r\n\t\tif ((ne.lng - sw.lng) > 180) {\r\n\t\t\treturn WORLDBBOX;\r\n\t\t}\r\n\t\tlet zoom = map.getZoom(),\r\n\t\t\tts = L.gmxUtil.tileSizes[zoom],\r\n\t\t\tpb = {x: ts, y: ts},\r\n\t\t\tmbbox = L.bounds(\r\n\t\t\t\tL.CRS.EPSG3857.project(sw)._subtract(pb),\r\n\t\t\t\tL.CRS.EPSG3857.project(ne)._add(pb)\r\n\t\t\t),\r\n\r\n\t\t\tminY = mbbox.min.y, maxY = mbbox.max.y,\r\n\t\t\tminX = mbbox.min.x, maxX = mbbox.max.x,\r\n\t\t\tminX1 = null, maxX1 = null,\r\n\t\t\tww = WORLDWIDTHFULL,\r\n\t\t\tsize = mbbox.getSize(),\r\n\t\t\tout = [];\r\n\r\n\t\tif (size.x > ww) {\r\n\t\t\treturn WORLDBBOX;\r\n\t\t}\r\n\r\n\t\tif (maxX > W || minX < -W) {\r\n\t\t\tvar hs = size.x / 2,\r\n\t\t\t\tcenter = ((maxX + minX) / 2) % ww;\r\n\r\n\t\t\tcenter = center + (center > W ? -ww : (center < -W ? ww : 0));\r\n\t\t\tminX = center - hs; maxX = center + hs;\r\n\t\t\tif (minX < -W) {\r\n\t\t\t\tminX1 = minX + ww; maxX1 = W; minX = -W;\r\n\t\t\t} else if (maxX > W) {\r\n\t\t\t\tminX1 = -W; maxX1 = maxX - ww; maxX = W;\r\n\t\t\t}\r\n\t\t}\r\n\t\tout.push([minX, minY, maxX, maxY]);\r\n\r\n\t\tif (minX1) {\r\n\t\t\tout.push([minX1, minY, maxX1, maxY]);\r\n\t\t}\r\n\t\treturn out;\r\n\t\t// return JSON.stringify(out);\r\n\t},\r\n\r\n\tsetSyncParams: (syncParams) => {\r\n\t\tsyncParams = syncParams || {};\r\n\t\tdataWorker.onmessage = (res) => {\r\n\t\t\tif (res.data.cmd === 'setSyncParams') {\r\n\t\t\t\tconsole.log('onmessage setSyncParams ', res);\r\n\t\t\t}\r\n\t\t};\r\n\t\tdataWorker.postMessage({cmd: 'setSyncParams', syncParams: syncParams});\r\n\t},\r\n\tgetSyncParams: (stringFlag) => {\r\n        return new Promise((resolve) => {\r\n\t\t\tdataWorker.onmessage = (res) => {\r\n\t\t\t\tif (res.data.cmd === 'getSyncParams') {\r\n\t\t\t\t\tresolve(res.data.syncParams);\r\n\t\t\t\t\tconsole.log('onmessage getSyncParams ', res);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tdataWorker.postMessage({cmd: 'getSyncParams', stringFlag: stringFlag});\r\n\t\t});\r\n\t},\r\n\tgetMap: (opt) => {\r\n\t\topt = opt || {};\r\n        return new Promise((resolve) => {\r\n\r\n\t\t\tdataWorker.onmessage = (res) => {\r\n\t\t\t\tlet data = res.data,\r\n\t\t\t\t\tcmd = data.cmd,\r\n\t\t\t\t\tjson = data.out;\r\n\r\n\t\t\t\tif (cmd === 'getMap') {\r\n\t\t\t\t\tresolve(json);\r\n\t\t\t\t}\r\n\t\t// console.log('onmessage', json);\r\n\t\t\t};\r\n\t\t\tdataWorker.postMessage({cmd: 'getMap', mapID: urlPars.main.length ? urlPars.main[0] : opt.mapID, hostName: opt.hostName, search: location.search});\r\n\t\t});\r\n\t}\r\n\r\n};\r\n\nL.Map.addInitHook(function () {\n\tlet map = this;\n\tmap\n\t\t.on('layeradd', (ev) => {\n\t\t\tif (ev.layer._gmx) {\r\n\t\t\t\tlet _gmx = ev.layer._gmx,\r\n\t\t\t\t\tdm = ev.layer.getDataManager(),\r\n\t\t\t\t\t// opt = dm.options,\r\n\t\t\t\t\tdtInterval = dm.getMaxDateInterval(),\r\n\t\t\t\t\tbeginDate = dtInterval.beginDate || _gmx.beginDate,\r\n\t\t\t\t\tendDate = dtInterval.endDate || _gmx.endDate,\r\n\t\t\t\t\tpars = {\r\n\t\t\t\t\t\tcmd: 'addDataSource',\r\n\t\t\t\t\t\tid: _gmx.layerID,\r\n\t\t\t\t\t\t// v: opt.LayerVersion,\r\n\t\t\t\t\t\thostName: _gmx.hostName,\r\n\t\t\t\t\t\tbbox: Utils.getBboxes(map),\r\n\t\t\t\t\t\tzoom: map.getZoom()\r\n\t\t\t\t\t};\r\n\t\t\t\tif (window.apiKey && pars.hostName === 'maps.kosmosnimki.ru') {\r\n\t\t\t\t\tpars.apiKey = window.apiKey;\r\n\t\t\t\t}\r\n\t\t\t\tif (beginDate) {\r\n\t\t\t\t\tpars.dateBegin = Math.floor(beginDate.getTime() / 1000);\r\n\t\t\t\t}\r\n\t\t\t\tif (endDate) {\r\n\t\t\t\t\tpars.dateEnd = Math.floor(endDate.getTime() / 1000);\r\n\t\t\t\t}\r\n\t\t\t\tif (map.options.generalized === false) {\r\n\t\t\t\t\tpars.generalizedTiles = false;\r\n\t\t\t\t}\r\n// console.log('layeradd', opt, dm.getD);\r\n\n\t\t\t\treturn new Promise((resolve) => {\n\t\t\t\t\tif (_gmx) {\n\t\t\t\t\t\tdataWorker.onmessage = (res) => {\n\t\t\t\t\t\t\tlet data = res.data,\n\t\t\t\t\t\t\t\tcmd = data.cmd,\n\t\t\t\t\t\t\t\tjson = data.out;\n\n\t\t\t\t\t\t\tif (cmd === 'addDataSource') {\n\t\t\t\t\t\t\t\tresolve(json);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t};\n\t\t\t\t\t\tdataWorker.postMessage(pars);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresolve({error: 'Not Geomixer layer'});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\r\n\t\t})\r\n\t\t.on('moveend', () => {\r\n\t\t\tdataWorker.postMessage({\r\n\t\t\t\tcmd: 'moveend',\r\n\t\t\t\tbbox: Utils.getBboxes(map),\r\n\t\t\t\tzoom: map.getZoom()\r\n\t\t\t});\r\n\t\t})\r\n\t\t.on('layerremove', (ev) => {\r\n\tconsole.log('layerremove', ev);\n\t\t\tlet it = ev.layer,\n\t\t\t\t_gmx = it._gmx;\n\n\t\t\treturn new Promise((resolve) => {\n\t\t\t\tif (_gmx) {\n\t\t\t\t\tdataWorker.onmessage = (res) => {\n\t\t\t\t\t\tlet data = res.data,\n\t\t\t\t\t\t\tcmd = data.cmd,\n\t\t\t\t\t\t\tjson = data.out;\n\n\t\t\t\t\t\tif (cmd === 'removeDataSource') {\n\t\t\t\t\t\t\tresolve(json);\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t\tdataWorker.postMessage({cmd: 'removeDataSource', id: _gmx.layerID, hostName: _gmx.hostName});\n\t\t\t\t} else {\n\t\t\t\t\tresolve({error: 'Not Geomixer layer'});\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\tUtils.getMap()\n\t\t.then(console.log)\n\n});\r\n\nL.gmxWorker = Utils;\r\n\r\nexport {dataWorker, Utils};"],"names":["_self","self","window","serverBase","gmxProxy","str","location","origin","_protocol","substring","indexOf","syncParams","fetchOptions","mode","redirect","credentials","COMPARS","WrapStyle","ftc","srs","setSyncParams","hash","getSyncParams","stringFlag","res","arr","key","push","join","parseURLParams","sp","URLSearchParams","search","out","p","k","z","main","keys","utils","extend","dest","i","j","len","src","arguments","length","makeTileKeys","it","ptiles","tklen","tilesOrder","tiles","newTiles","t","splice","tk","tile","data","tp","x","y","v","s","d","getZoomRange","info","properties","styles","st","Math","min","MinZoom","max","MaxZoom","chkProtocol","url","substr","getFormBody","par","Object","map","encodeURIComponent","chkResponse","resp","type","status","Promise","reject","contentType","headers","get","blob","json","text","getJson","queue","params","paramsArr","forEach","options","opt","method","body","fetch","then","load","catch","err","error","toString","parseLayerProps","prop","getTileAttributes","parseMetaProps","meta","MetaProperties","ph","dataSource","LayerID","parentLayer","Value","toLowerCase","tileAttributeIndexes","tileAttributeTypes","attributes","attrs","attrTypes","identityField","a","_maps","getMapTree","pars","hostName","id","mapId","skipTiles","folderId","visibleItemOnly","parseTree","_iterateNodeChilds","node","level","layers","content","props","geometry","childs","children","group","childsLen","Status","Result","mapAttr","shift","chkSignal","signalName","signals","sObj","abort","AbortController","signal","addEventListener","ev","console","log","dataWorker","DataWorker","urlPars","Requests","WORLDWIDTHFULL","W","WORLDBBOX","Utils","getBboxes","allWorld","bbox","getBounds","ne","getNorthEast","sw","getSouthWest","lng","zoom","getZoom","ts","L","gmxUtil","tileSizes","pb","mbbox","bounds","CRS","EPSG3857","project","_subtract","_add","minY","maxY","minX","maxX","minX1","maxX1","ww","size","getSize","hs","center","onmessage","cmd","postMessage","resolve","getMap","mapID","Map","addInitHook","on","layer","_gmx","dm","getDataManager","dtInterval","getMaxDateInterval","beginDate","endDate","layerID","apiKey","dateBegin","floor","getTime","dateEnd","generalized","generalizedTiles","gmxWorker"],"mappings":"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"}